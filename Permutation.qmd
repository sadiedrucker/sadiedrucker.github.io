---
title: "Bill length in male vs female penguins"
format: 
  html:
    code-fold: true
    
execute:
  message: false
  warning: false
  echo: true
---

## Background 

This simulation study investigates whether there is a statistically significant difference in bill length between male and female penguins, testing the alternative hypothesis that bill length varies by sex. he analysis uses data from the *palmerpenguins* dataset in R, which contains morphological measurements for three penguin species from the Palmer Archipelago in Antarctica. Understanding differences in bill length across sexes can provide insights into sexual dimorphism and ecological adaptations in penguin species. A permutation test was conducted to simulate the distribution of mean differences under the null hypothesis that bill length is independent of sex, allowing for an assessment of whether the observed difference is more likely due to random chance.

## Visualization of variables of interest 

```{r}
library(tidyverse)
library(palmerpenguins)
library(ggplot2)

clean_penguins <- penguins |>
  filter(!is.na(bill_length_mm), !is.na(sex))

ggplot(clean_penguins, aes(x=sex, y=bill_length_mm, fill=sex))+
  geom_boxplot()+
    labs(
      title = "Bill length in male vs female penguins" , 
      x= "Sex",
      y= "Bill length in mm"
      )+
  theme_minimal()



```

In the original data presented in the above graph, male penguins have a greater median bill length. To reject the null hypothesis, we performed a permutation test to determine whether this observed difference between sexes is likely to have occurred by chance.

## Permutation Test 

### Step 1: Define the null hypothesis 

In this case, the null hypothesis is that bill length is independent of sex in penguins.

### Step 3: Permute (shuffle) the variable labels

This forces the null hypothesis to be true.

### Step 3: Compute the observed test statistic on the null sampling distribution.

We do this by computing the mean and median differences between the sexes. I created a function called *`perm_data()`*. This function keeps track of the current replication number, *rep*, and the data set containing *`sex`* and *`bill_length_mm.`*The function mutates the data set to add a column called *`sex_perm.`* that randomly shuffles the sex labels. This action simulates the null hypothesis.

The mapping function quickly tests if the function is working as expected.

## 

```{r}
#Permutation test 

set.seed(47) 

perm_data <- function(rep, data){
  data |> 
    select(sex, bill_length_mm) |> 
    mutate(sex_perm = sample(sex, replace = FALSE)) |>
    summarize(
      obs_ave_diff = mean(bill_length_mm[sex == "male"], na.rm = TRUE) - 
                     mean(bill_length_mm[sex == "female"], na.rm = TRUE),
      obs_median_diff = median(bill_length_mm[sex == "male"], na.rm = TRUE) - 
                        median(bill_length_mm[sex == "female"], na.rm = TRUE),
      perm_ave_diff = mean(bill_length_mm[sex_perm == "male"], na.rm = TRUE) - 
                      mean(bill_length_mm[sex_perm == "female"], na.rm = TRUE),
      perm_median_diff = median(bill_length_mm[sex_perm == "male"], na.rm = TRUE) - 
                         median(bill_length_mm[sex_perm == "female"], na.rm = TRUE),
              rep = rep)
}
  
map(c(1:10), perm_data, data = clean_penguins) |> 
  list_rbind()
```

### Step 4: Visualize null sampling distributions 

The mapping function used here runs the function *`perm_data()`* one thousand times to simulate the permutation distribution.

Each row in *`perm_stats`* represents one shuffled permutation: the permuted mean and median differences and the observed statistics.

```{r}
set.seed(47)
perm_stats <- 
  map(c(1:1000), perm_data, data = clean_penguins) |> 
  list_rbind() 

perm_stats |> 
  ggplot(aes(x = perm_ave_diff)) + 
  geom_histogram() + 
  geom_vline(aes(xintercept = obs_ave_diff), color = "red")+
  labs(
    title="Mean null sampling distributions "
  )

```

```{r}
perm_stats |> 
  ggplot(aes(x = perm_median_diff)) + 
  geom_histogram() + 
  geom_vline(aes(xintercept = obs_median_diff), color = "red")+
   labs(
    title="Median null sampling distributions "
  )
```

### Step 5: Compute the p-value 

This value indicates the probability of observing the data or more extreme outcomes if the null hypothesis is true. In other words, the probability that the pattern in the original observed data is due to random chance.

```{r}

 perm_stats |> 
  summarize(
    p_val_ave = (sum(abs(perm_ave_diff) >= abs(obs_ave_diff[1])) + 1) / (n() + 1),
    p_val_median = (sum(abs(perm_median_diff) >= abs(obs_median_diff[1])) + 1) / (n() + 1)
  ) 
```

## Conclusion

The permutation test provides strong evidence that male and female penguins have different bill lengths. Both the mean and median differences are far outside the distribution expected under the null hypothesis of no difference. The extremely small p-values (p â‰ˆ 0.001) indicate that the observed differences are highly unlikely to have occurred by random chance, confirming significant sexual dimorphism in bill length.
